<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Leandro Adrian da Silva">
    <meta name="description" content="Lista de tarefas para você se organizar de maneira rápida e intuitiva">
    <meta name="theme-color" content="#02a267">
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <!-- Markdown -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/1614cc0d63.js" crossorigin="anonymous"></script>

    <title>TaskFlow</title>
</head>

<body>
    <div class="loader-container">
        <span class="spinner"></span>
    </div>

    <div id="app">
        <header class="header-wrapper">
            <div class="header container">
                <div class="header__logo">
                    <button class="btn only-icon bg-primary btn-mobile" @click="toggleTopicsMenu" v-if="showBtn">
                        <i class="fa-solid fa-bars"></i>
                    </button>

                    <router-link to="/" title="Acessar página incial" class="logo">
                        <img src="./assets/img/logo_lg.svg" alt="TaskFlow - logo do website" width="148" height="37"
                            loading="lazy" v-if="!showBtn">
                        <img src="./assets/img/logo_sm.svg" alt="TaskFlow - logo do website" width="118" height="37"
                            loading="lazy" v-if="showBtn">
                    </router-link>
                </div>

                <button class="account btn bordered" @click.stop="toggleUserDropdown" title="Abrir/fechar dropdown"
                    v-if="user">

                    <div class="account__details">
                        <p class="text small">Olá, {{ user.displayName }}</p>
                        <p class="text smallest">{{ user.email }}</p>
                    </div>

                    <img class="account__avatar" :src="user.photoURL" alt="Foto de perfil do usuário" width="37"
                        height="37" :title="`Logado como: ${user.email}`">

                    <span class="account__arrow"> <i class="fa-solid fa-caret-down"></i> </span>
                </button>

                <div :class="['dropdown', isUserDropdownActive && 'active']">
                    <div class="dropdown__menu">
                        <button class="btn outline-danger btn-icon" @click="logoutUser" title="Sair da minha conta">
                            <i class="fa-solid fa-right-from-bracket"></i> Sair da conta
                        </button>
                        <button class="btn bg-danger btn-icon" @click="removeUser" title="Excluir minha conta">
                            <i class="fa-solid fa-right-from-bracket"></i> Excluir conta
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <router-view></router-view>
        </main>

        <div :class="['toast', toast ? `${toast.type}-toast active` : '']">
            <div class="toast-banner"></div>
            <div class="toast-content text">
                <div class="toast-icon">
                    <i :class="['fa-solid', toast && toast.type == 'error' ? 'fa-xmark' : 'fa-check']"></i>
                </div>
                <div>
                    <p class="toast-title">{{ toast && toast.type == 'error' ? 'Erro' : 'Sucesso' }}</p>
                    <p class="toast-text"> {{ toast && toast.text }}</p>
                </div>
                <button class="btn" @click="closeToast" title="Fechar mensagem">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <template id="login-page">
        <div class="form-wrapper">
            <form style="--form-width: 450px" @submit.prevent="loginGoogle">
                <img src="./assets/img/login_lg.png" alt="Uma pessoa escrevendo em um caderno" class="large-screen"
                    width="1200" height="800" loading="lazy">
                <img src="./assets/img/login_sm.png" alt="Uma pessoa escrevendo em um caderno" class="small-screen"
                    width="640" height="640" loading="lazy">
                <button class="btn block btn-icon bg-primary" title="Entrar com o Google"><i
                        class="fa-brands fa-google"></i> Entrar com o Google</button>
            </form>
        </div>
    </template>

    <template id="home-page">
        <div>
            <div class="home-wrapper" v-if="loadedTopics">
                <div :class="['topic-container', isMenuTopicsActive && 'active']">
                    <form @submit.prevent="addTopic">
                        <div class="form-group">
                            <div :class="['input-group', formTopicError ? 'input-error' : '']">
                                <input type="text" placeholder="Adicionar novo tópico" v-model="newTopic"
                                    autocomplete="off">
                                <button class="btn" title="Adicionar novo tópico"><i
                                        class="fa-solid fa-plus"></i></button>
                            </div>
                            <p class="text text-error" v-if="formTopicError">{{ formTopicError }}</p>
                        </div>
                    </form>

                    <span class="divider"></span>

                    <div v-if="topics">
                        <h2 class="subtitle">Seus tópicos</h2>
                        <div class="topic-nav">
                            <router-link @click.native="closeTopicsMenu" :to="'/topic/' + topic.id"
                                class="btn btn-topic" role="button" v-for="topic in topics"
                                :title="'Acessar tópico ' + topic.name">
                                <div class="topic-data">
                                    <p class="text">{{ topic.name }}</p>
                                    <p class="text small muted">{{ `${topic.tasks_length} ${topic.tasks_length == 1 ?
                                        'tarefa' : 'tarefas'}` }} </p>
                                </div>
                                <div class="topic-actions">
                                    <button class="btn rounded" title="Editar tópico"
                                        @click.prevent="openEditTopic(topic.name)">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button class="btn rounded" title="Excluir tópico"
                                        @click.prevent="deleteTopic(topic.name)">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </router-link>
                        </div>
                    </div>

                    <div class="topic-container-bottom" v-if="topics">
                        <span class="divider"></span>

                        <router-link to="/kanban" class="btn outline-primary btn-icon block block-small"
                            title="Acessar Kanban">
                            <i class="fa-solid fa-chart-simple"></i>
                            Acessar Kanban
                        </router-link>

                        <router-link to="/general" class="btn outline-primary btn-icon block block-small"
                            title="Visualização geral"><i class="fa-solid fa-eye"></i>
                            Visão geral das tarefas
                        </router-link>

                        <button class="btn btn-icon block block-small outline-danger" title="Excluir todos os tópicos"
                            @click="deleteAllTopics">
                            <i class="fa-solid fa-trash"></i> Excluir todos os tópicos
                        </button>

                        <a title="Acessar GitHub" href="https://lezzin.github.io" target="_blank">
                            <i class="fab fa-github"></i> Criado por Leandro Adrian da Silva
                        </a>
                    </div>
                    <p class="text center" v-else>Nenhum tópico cadastrado</p>
                </div>

                <div class="task-container container" v-if="selectedTopic">
                    <div id="add-task-container">
                        <button @click="openAddTask" title="Abrir modal de nova tarefa"
                            class="btn rounded outline-primary">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <div v-if="defaultTasks.length > 0">
                        <h2 class="subtitle large-screen">{{ selectedTopic.name }}</h2>

                        <div class="form-container">
                            <div class="form-container-row">
                                <form onsubmit="return false" class="form-100">
                                    <div class="form-group">
                                        <label for="search-task" class="text">Pesquisar</label>
                                        <div class="input-group">
                                            <input type="text" @input="searchTaskByName" id="search-task"
                                                placeholder="Descrição da tarefa" v-model="searchTask"
                                                autocomplete="off">
                                            <button type="submit" class="btn" title="Pesquisar tarefa"><i
                                                    class="fa-solid fa-search"></i></button>
                                        </div>
                                    </div>
                                </form>
                                <form onsubmit="return false" class="form-100">
                                    <div class="form-group">
                                        <label for="filter-task" class="text">Filtrar</label>
                                        <div class="select">
                                            <select id="filter-task" @change="searchTaskByStatus" v-model="filterTask">
                                                <option value="all">Todas</option>
                                                <option value="completed">Concluídas</option>
                                                <option value="not-completed">Não concluídas</option>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <span class="divider"></span>

                        <div class="task-nav">
                            <div :class="`task ${task.status && 'completed'}`" v-for="task in selectedTopic.tasks">
                                <div class="right-content">
                                    <button :class="`btn bordered rounded ${task.status && 'bg-primary'}`"
                                        :title="`Marcar tarefa como ${task.status ? 'não concluída' : 'concluída'}`"
                                        @click="changeTaskStatus(task.id)">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <div class="task-information">
                                        <p class="text">{{ task.name }}</p>

                                        <p class="task-information-small">
                                            <span :class="['tag', getPriorityClass(task.priority)]">
                                                <i class="fa-solid fa-exclamation-circle"></i>
                                                {{ getPriorityText(task.priority) }}
                                            </span>

                                            <span class="text text-icon small">
                                                <i class="fa-regular fa-clock"></i>
                                                Criado em: {{ task.created_at }}
                                            </span>
                                            <span class="text text-icon small" v-if="task.delivery_date">
                                                <i class="fa-regular fa-bell"></i>
                                                Entrega para: {{ formatDate(task.delivery_date) }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div class="task-action">
                                    <button class="btn rounded bg-primary" title="Visualizar comentários da tarefa"
                                        @click="openTaskComment(task.comment)" v-if="task.comment">
                                        <span class="fa-solid fa-comment"></span>
                                    </button>
                                    <button class="btn rounded bg-primary" title="Editar tarefa"
                                        @click="openEditTask(task)">
                                        <span class="fa-solid fa-pen"></span>
                                    </button>
                                    <button class="btn rounded bg-danger" title="Excluir tarefa"
                                        @click="deleteTask(selectedTopic.name, task.id)">
                                        <span class="fa-solid fa-trash"></span>
                                    </button>
                                </div>
                            </div>
                            <p class="text center" v-if="selectedTopic.tasks.length === 0">
                                Nenhuma tarefa para esse filtro
                            </p>
                        </div>
                    </div>
                    <div v-else>
                        <img src="./assets/img/task_empty_lg.png"
                            alt="Frase tarefas vazias e uma imagem de uma caixa vazia" class="large-screen"
                            loading="lazy">
                        <img src="./assets/img/task_empty_sm.png"
                            alt="Frase tarefas vazias e uma imagem de uma caixa vazia" class="small-screen"
                            loading="lazy">
                    </div>
                </div>
                <div class="container" v-else>
                    <img src="./assets/img/topic_unselected_lg.png"
                        alt="Uma pessoa escrevendo em um diário suas tarefas pessoais" class="large-screen"
                        loading="lazy">
                    <img src="./assets/img/topic_unselected_sm.png"
                        alt="Uma pessoa escrevendo em um diário suas tarefas pessoais" class="small-screen"
                        loading="lazy">
                </div>
            </div>

            <aside :class="['modal', editingTopic && 'active']">
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="title">Editar tópico</h2>
                        <button class="btn" @click="closeEditingTopic" title="Fechar modal"><i
                                class="fa-solid fa-times"></i></button>
                    </div>

                    <form @submit.prevent="editTopic">
                        <div :class="['form-group', topicEditingError ? 'input-error' : '']">
                            <label class="text" for="edit-topic-name">Nome</label>
                            <input type="text" id="edit-topic-name" v-model="topicNewName"
                                :class="{ 'input-error' : topicEditingError }">
                            <p class="text text-error" v-if="topicEditingError">{{ topicEditingError }}</p>
                        </div>

                        <button type="submit" class="btn bg-primary block" title="Concluir edição do tópico"><i
                                class="fa-solid fa-check"></i> Concluir edição</button>
                    </form>
                </div>
            </aside>

            <aside :class="['modal', showingComment && 'active']">
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="title">Comentários da tarefa</h2>
                        <button class="btn" @click="closeShowingComment" title="Fechar modal">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <div class="markdown-content markdown-content--normal" v-html="selectedComment"></div>
                </div>
            </aside>

            <aside :class="['modal', editingTask && 'active']">
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="title">Editar tarefa</h2>
                        <button class="btn" @click="closeEditingTask" title="Fechar modal"><i
                                class="fa-solid fa-times"></i></button>
                    </div>

                    <form @submit.prevent="editTask">
                        <div class="form-group">
                            <label class="text" for="edit-task-name">Nome</label>
                            <div :class="['input-group', 'input-group-btn', formTaskError ? 'input-error' : '']">
                                <input type="text" id="edit-task-name" v-model="editNewTaskName">
                                <button type="button" class="btn" title="Editar tarefa através de áudio"
                                    @click="toggleSpeechRecognition('editTask')">
                                    <i :class="['fa-solid', isListening ? 'fa-stop' : 'fa-microphone']"></i>
                                </button>
                            </div>
                            <p class="text text-error" v-if="editNewTaskNameError">{{ editNewTaskNameError }}</p>
                        </div>

                        <div class="form-group">
                            <label class="text" for="edit-task-date">Data de entrega (opcional)</label>
                            <input type="date" id="edit-task-date" v-model="editNewTaskDate">
                        </div>

                        <div class="form-group">
                            <label class="text" for="edit-task-comment">Comentários (opcional)</label>
                            <input type="text" id="edit-task-comment">
                        </div>

                        <div class="form-group">
                            <label class="text" for="edit-task-priority">Prioridade</label>
                            <div class="select">
                                <select id="edit-task-priority" v-model="editNewTaskPriority"
                                    :class="{ 'input-error' : editNewTaskPriorityError }">
                                    <option value="1">Baixa</option>
                                    <option value="2">Média</option>
                                    <option value="3">Alta</option>
                                </select>
                            </div>
                            <p class="text text-error" v-if="editNewTaskPriorityError">{{ editNewTaskPriorityError }}
                            </p>
                        </div>

                        <button type="submit" class="btn bg-primary block" title="Concluir edição da tarefa">
                            <i class="fa-solid fa-check"></i> Concluir edição
                        </button>
                    </form>
                </div>
            </aside>

            <aside :class="['modal', addingTask && 'active']">
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h2 class="title">Adicionar tarefa</h2>
                        <button class="btn" @click="closeAddingTask" title="Fechar modal"><i
                                class="fa-solid fa-times"></i></button>
                    </div>

                    <form @submit.prevent="addTask">
                        <div class="form-group">
                            <label class="text" for="add-task-name">Nome da tarefa</label>
                            <div :class="['input-group', 'input-group-btn', formTaskError ? 'input-error' : '']">
                                <input type="text" id="add-task-name" placeholder="Adicionar tarefa..."
                                    v-model="addNewTaskName" autocomplete="off">
                                <button type="button" class="btn" title="Adicionar tarefa através de áudio"
                                    @click="toggleSpeechRecognition('addTask')">
                                    <i :class="['fa-solid', isListening ? 'fa-stop' : 'fa-microphone']"></i>
                                </button>
                            </div>
                            <p class="text text-error" v-if="formTaskError">{{ formTaskError }}</p>
                        </div>

                        <div class="form-group">
                            <label class="text" for="add-task-date">Data de entrega (opcional)</label>
                            <input type="date" v-model="addNewTaskDate" id="add-task-date">
                        </div>

                        <div class="form-group">
                            <label class="text" for="add-task-comment">Comentários (opcional)</label>
                            <input type="text" id="add-task-comment">
                        </div>

                        <div class="form-group">
                            <label class="text" for="edit-task-priority">Prioridade</label>
                            <div class="select">
                                <select id="edit-task-priority" v-model="addNewTaskPriority">
                                    <option value="1">Baixa</option>
                                    <option value="2">Média</option>
                                    <option value="3">Alta</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn bg-primary block" title="Concluir adição da tarefa">Adicionar
                            tarefa</button>
                    </form>
                </div>
            </aside>
        </div>
    </template>

    <template id="general-page">
        <div v-if="loadedTasks">
            <div class="calendar-wrapper container" id="pdf-container" v-if="allUserTasks.length > 0">
                <div class="calendar-header">
                    <h2 class="subtitle">Visualize as suas tarefas de uma maneira geral</h2>
                    <div class="header-buttons">
                        <button type="button" @click="downloadAsPDF" class="btn bg-primary only-icon"
                            title="Baixar em PDF"><i class="fa-solid fa-download"></i></button>
                        <button @click="sendBack()" class="btn outline-primary btn-icon" title="Voltar para o início">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item completed" @mouseover="focusTasksByPriority('completed')"
                        @mouseleave="removeFocusFromTasks">
                        <p class="text small"><i class="fa-solid fa-check"></i>
                            Concluídas ({{ priorityCount.completed }})
                        </p>
                    </div>

                    <div class="legend-item priority-high" @mouseover="focusTasksByPriority('3')"
                        @mouseleave="removeFocusFromTasks">
                        <p class="text small">
                            <i class="fa-regular fa-calendar"></i>
                            Prioridade alta ({{ priorityCount.high }})
                        </p>
                    </div>

                    <div class="legend-item priority-medium" @mouseover="focusTasksByPriority('2')"
                        @mouseleave="removeFocusFromTasks">
                        <p class="text small">
                            <i class="fa-regular fa-calendar"></i>
                            Prioridade média ({{ priorityCount.medium }})
                        </p>
                    </div>

                    <div class="legend-item priority-small" @mouseover="focusTasksByPriority('1')"
                        @mouseleave="removeFocusFromTasks">
                        <p class="text small"><i class="fa-regular fa-calendar"></i> Prioridade baixa ({{
                            priorityCount.small }})</p>
                    </div>
                </div>

                <span class="divider"></span>

                <div class="calendar">
                    <router-link
                        :class="['calendar-item', 'task', task.status && 'completed', { 'is-hovering': task.isHovering, 'focused': task.isFocused }]"
                        v-for="task in allUserTasks" role="button" :to="'/topic/' + task.topic_id"
                        title="Acessar tópico">
                        <div class="calendar-item-header">
                            <p class="text smallest muted">{{ task.topic_name }}</p>
                            <div class="task-informations">
                                <p class="text">{{ task.name }}</p>

                                <div class="task-informations-small">
                                    <span :class="['tag', getPriorityClass(task.priority)]">
                                        <i class="fa-solid fa-exclamation-circle"></i>
                                        {{ getPriorityText(task.priority) }}
                                    </span>
                                    <p class="text text-icon small"><i class="fa-regular fa-clock"></i> Criado
                                        em:
                                        {{ task.created_at }}
                                    </p>
                                    <p class="text text-icon small" v-if="task.delivery_date"><i
                                            class="fa-regular fa-bell"></i> Entrega para: {{
                                        formatDate(task.delivery_date) }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="calendar-item-footer" v-if="task.comment">
                            <div class="task-comment">
                                <p class="text small muted">Comentário da tarefa:</p>

                                <div class="markdown-content markdown-content--small"
                                    v-html="formatComment(task.comment)"></div>
                            </div>
                        </div>
                    </router-link>
                </div>
            </div>
            <div class="container" v-else>
                <router-link to="/" title="Voltar para o início">
                    <img src="./assets/img/task_empty_lg.png" alt="Frase tarefas vazias e uma imagem de uma caixa vazia"
                        class="large-screen" width="1200" height="640" loading="lazy">
                    <img src="./assets/img/task_empty_sm.png" alt="Frase tarefas vazias e uma imagem de uma caixa vazia"
                        class="small-screen" width="640" height="640" loading="lazy">
                </router-link>
            </div>
        </div>
    </template>

    <template id="kanban-page">
        <div v-if="loadedTasks">
            <div class="kanban-wrapper container" v-if="tasksLength > 0">
                <div class="kanban-header">
                    <button @click="sendBack" class="btn outline-primary btn-icon" title="Voltar para o início">
                        <i class="fa-solid fa-arrow-left"></i>
                        Voltar para o início
                    </button>
                </div>

                <div class="kanban">
                    <div class="kanban-column" :class=" { 'drag-over': activeColumn === kanbanStatus }"
                        v-for="kanbanStatus in ['todo', 'doing', 'completed']" :key="kanbanStatus"
                        @drop="onDrop(kanbanStatus)" @dragover="onDragOver"
                        @dragenter="event => onDragEnter(event, kanbanStatus)"
                        @touchstart="handleTouchStart($event, kanbanStatus)" @touchend="handleTouchEnd($event)"
                        :data-status="kanbanStatus">
                        <h2 class="subtitle">
                            {{ kanbanStatus === 'todo' ? 'Para fazer' : kanbanStatus === 'doing' ? 'Fazendo' :
                            'Concluído'
                            }}
                        </h2>

                        <div class="kanban-tasks">
                            <div class="task task-empty" v-if="tasks[kanbanStatus] == 0">
                                <i class="fa-solid fa-exclamation-triangle"></i>
                                <p class="text">Nenhuma tarefa na coluna</p>
                            </div>
                            <div v-else v-for="task in tasks[kanbanStatus]" :key="task.id"
                                :class="['task', task.status && 'completed']" draggable="true"
                                @dragstart="handleDragEvents($event, 'start', task)"
                                @dragend="handleDragEvents($event, 'end')" @touchstart="handleTouchStart($event, task)"
                                @touchend="handleTouchEnd($event, task)">

                                <router-link class="text task-name" :to="'/topic/' + task.topic_id">
                                    {{ task.name }}
                                </router-link>

                                <span :class="['tag', getPriorityClass(task.priority)]">
                                    <i class="fa-solid fa-exclamation-circle"></i>
                                    {{ getPriorityText(task.priority) }}
                                </span>

                                <div class="task-information">
                                    <span class="text text-icon small muted">
                                        <i class="fa-regular fa-clock"></i>
                                        Criado em: {{ task.created_at }}
                                    </span>
                                    <span class="text text-icon small muted" v-if="task.delivery_date">
                                        <i class="fa-regular fa-bell"></i>
                                        Entrega para: {{ formatDate(task.delivery_date) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container" v-else>
                <router-link to="/" title="Voltar para o início">
                    <img src="./assets/img/task_empty_lg.png" alt="Frase tarefas vazias e uma imagem de uma caixa vazia"
                        class="large-screen" loading="lazy">
                    <img src="./assets/img/task_empty_sm.png" alt="Frase tarefas vazias e uma imagem de uma caixa vazia"
                        class="small-screen" width="640" height="640" loading="lazy">
                </router-link>
            </div>
        </div>
    </template>

    <template id="not-found-page">
        <div class="container">
            <img src="./assets/img/not_found_lg.png" alt="Homem segurando uma lupa e frase de página não encontrada"
                class="large-screen" width="1200" height="640" loading="lazy">
            <img src="./assets/img/not_found_sm.png" alt="Homem segurando uma lupa e frase de página não encontrada"
                class="small-screen" width="640" height="640" loading="lazy">
        </div>
    </template>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router@3"></script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <script src="./assets/js/app.js" type="module"></script>
</body>

</html>